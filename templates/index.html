<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ€ Photobooth Clovers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: sans-serif; background:#f9f9f9; margin:0; padding:2rem; color:#333; }
    .container { max-width:600px; margin:auto; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; }
    form { display:flex; flex-direction:column; gap:1rem; }
    input { padding:0.8rem; border:1px solid #ccc; border-radius:8px; }
    button { padding:0.8rem; border:none; border-radius:8px; background:#2e7d32; color:#fff; cursor:pointer; font-weight:bold; }
    button:hover { background:#256428; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; table-layout: fixed; }
    th, td { border:1px solid #ddd; padding:0.6rem; text-align:left; word-wrap:break-word; white-space: normal; }
    th { background:#f0f0f0; }
    .badge { padding:0.2rem 0.6rem; border-radius:6px; font-size:0.85rem; font-weight:bold; }
    .pending { background:#ffecb3; color:#8a6d00; }
    .done { background:#4a7a44; color:#fff; }
    .top-actions { margin-top:1rem; display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; }
    .btn-secondary { background:#eee; color:#333; }
    .btn-secondary:hover { background:#ddd; }
  </style>
</head>
<body>
<div class="container">

  {% if page == 'form' %}
    <h1>ğŸ€ Clovers Photobooth ğŸ“¸ â€” Order Form</h1>
    <form action="{{ url_for('submit') }}" method="POST" onsubmit="return validateEmail(this)">
      <input type="text" name="name" placeholder="Full Name" required>
      <input type="email" name="email" placeholder="Email (optional)">
      <input type="number" name="copies" placeholder="Number of Copies" min="1" required>
      <input type="number" name="amount" placeholder="Amount Paid" min="0" required>
      <input type="hidden" name="timestamp" id="timestamp">
      <button type="submit">Submit Order</button>
    </form>
    <div class="top-actions">
      <a href="{{ url_for('queue') }}"><button class="btn-secondary" type="button">View Queue</button></a>
      <a href="{{ url_for('admin') }}"><button class="btn-secondary" type="button">Admin</button></a>
    </div>

  {% elif page == 'thanks' %}
    <h1>âœ… Order Submitted! Thank you! ğŸ˜</h1>
    <p style="text-align:center;">Your queue number: <b>#{{ position }}</b></p>
    <div class="top-actions">
      <a href="{{ url_for('queue') }}"><button type="button">Go to Queue</button></a>
      <a href="{{ url_for('form') }}"><button class="btn-secondary" type="button">Submit Another</button></a>
    </div>

  {% elif page == 'queue' %}
    <h1>ğŸ“‹ Live Queue</h1>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Copies</th><th>Amount</th></tr></thead>
      <tbody id="queue-body">
        {% set pending = orders | selectattr("Status", "equalto", "Pending") | list %}
        {% for r in pending %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r["Name"] }}</td>
            <td>{{ r["Copies"] }}</td>
            <td>{{ r["Amount Paid"] }}</td>
          </tr>
        {% endfor %}
        {% if pending|length == 0 %}
          <tr><td colspan="4">No pending orders ğŸ‰</td></tr>
        {% endif %}
      </tbody>
    </table>
    <div class="top-actions">
      <a href="{{ url_for('form') }}"><button class="btn-secondary" type="button">Back to Form</button></a>
    </div>

  {% elif page == 'login' %}
    <h1>ğŸ”‘ Admin Login</h1>
    <form method="POST">
      <input type="password" name="password" placeholder="Admin Password" required>
      <button type="submit">Login</button>
    </form>
    {% if error %}<p style="color:red">{{ error }}</p>{% endif %}

  {% elif page == 'admin' %}
    <h1>ğŸ›  Admin Dashboard</h1>
    <div class="top-actions">
      <a href="{{ url_for('logout') }}"><button class="btn-secondary" type="button">Logout</button></a>
      <a href="{{ url_for('queue') }}"><button class="btn-secondary" type="button">View Queue</button></a>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Name</th><th>Email</th><th>Copies</th><th>Amount</th><th>Status</th><th>Timestamp</th><th>Action</th></tr>
      </thead>
      <tbody id="admin-body">
        {% for r in orders %}
          <tr>
            <td>{{ r["ID"] }}</td>
            <td>{{ r["Name"] }}</td>
            <td style="max-width:150px; word-wrap:break-word; white-space:normal;">{{ r["Email"] }}</td>
            <td>{{ r["Copies"] }}</td>
            <td>{{ r["Amount Paid"] }}</td>
            <td><span class="badge {{ 'pending' if r['Status']=='Pending' else 'done' }}">{{ r["Status"] }}</span></td>
            <td>{{ r["Timestamp"] }}</td>
            <td>
              <form method="POST" action="{{ url_for('toggle', order_id=r['ID']) }}">
                <button type="submit">
                  {% if r["Status"] == "Pending" %}Mark Done{% else %}Undo{% endif %}
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<script>
  const socket = io();

  // Add timestamp before submitting
  function addTimestamp() {
    const now = new Date();
    const ts = now.getFullYear() + "-" +
               String(now.getMonth()+1).padStart(2,"0") + "-" +
               String(now.getDate()).padStart(2,"0") + " " +
               String(now.getHours()).padStart(2,"0") + ":" +
               String(now.getMinutes()).padStart(2,"0") + ":" +
               String(now.getSeconds()).padStart(2,"0");
    document.getElementById("timestamp").value = ts;
  }

  // Validate email domains
  function validateEmail(form) {
    addTimestamp();
    const emailField = form.email.value.trim();
    if (emailField.length === 0) return true; // optional

    const allowedDomains = ["gmail.com", "up.edu.ph"];
    const domain = emailField.split("@").pop().toLowerCase();
    if (!allowedDomains.includes(domain)) {
      alert("Only gmail.com or up.edu.ph emails are allowed.");
      return false;
    }
    return true;
  }

  // Live queue updates
  socket.on("queue_update", (queue) => {
    if (window.location.pathname === "/queue") {
      const tbody = document.getElementById("queue-body");
      tbody.innerHTML = "";
      const pending = queue.filter(o => o.Status === "Pending");
      if (pending.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>No pending orders ğŸ‰</td></tr>";
      } else {
        pending.forEach((order, idx) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${order.Name}</td>
            <td>${order.Copies}</td>
            <td>${order["Amount Paid"]}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }
    if (window.location.pathname === "/admin") {
      window.location.reload(); // refresh admin instantly
    }
  });
</script>

</body>
</html>
